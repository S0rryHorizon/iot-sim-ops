<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iot-sim-ops · 登录</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{min-height:100%;display:grid;place-items:center;background:#0f172a;color:#e2e8f0}
    .card{width:360px;background:#111827;border:1px solid #1f2937;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 16px;font-size:22px}
    label{display:block;font-size:13px;color:#9ca3af;margin:8px 0 6px}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
    button{width:100%;padding:12px;border:0;border-radius:12px;background:#22c55e;color:#052e16;font-weight:700;margin-top:16px;cursor:pointer}
    .muted{font-size:12px;color:#9ca3af;margin-top:10px}
    .err{background:#7f1d1d;color:#fecaca;border:1px solid #991b1b;padding:10px;border-radius:10px;margin-top:12px;display:none;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>登录 iot-sim-ops</h1>
      <form id="f" autocomplete="off">
        <label>用户名</label>
        <input id="username" placeholder="请输入用户名" autocomplete="username" />

        <label>密码</label>
        <input id="password" type="password" placeholder="请输入密码" autocomplete="current-password" />

        <button type="submit">登录</button>
        <div id="err" class="err"></div>
        <div class="muted">演示账号：alice / user1pass，或 bob / user2pass</div>
      </form>
    </div>
  </div>

  <script>
    const baseUrl = location.origin;
    const errBox = document.getElementById('err');
    const $ = (id)=>document.getElementById(id);

    function showErr(msg) {
      errBox.textContent = msg || '登录失败';
      errBox.style.display = 'block';
    }

    document.getElementById('f').addEventListener('submit', async (e) => {
      e.preventDefault();
      errBox.style.display = 'none';

      const username = $('username').value.trim();
      const password = $('password').value;

      if (!username || !password) {
        showErr('请填写用户名和密码');
        return;
      }

      try {
        const res = await fetch(`${baseUrl}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const text = await res.text();
        let j;
        try { j = JSON.parse(text); } catch { j = { detail: text }; }

        if (!res.ok) {
          console.error('Login failed:', res.status, j);
          showErr(j?.detail || j?.msg || `登录失败（HTTP ${res.status}）`);
          return;
        }

        if (!j?.data?.token) {
          showErr('登录成功但返回格式异常：缺少 token');
          return;
        }

        localStorage.setItem('token', j.data.token);
        localStorage.setItem('loginUser', username);

        // 跳转到控制台
        window.location.assign(`${baseUrl}/web/index.html`);
      } catch (err) {
        console.error(err);
        showErr(err.message || '网络错误');
      }
    });
  </script>
</body>
</html>

